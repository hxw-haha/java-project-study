<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hanxw.project.order.mapper.OrderMapper">

    <!-- 订单项 resultMap -->
    <resultMap id="orderItemMap" type="com.hanxw.project.order.entity.OrderItemEntity">
        <id property="id" column="item_id"/>
        <result property="orderId" column="order_id"/>
        <result property="productName" column="product_name"/>
        <result property="price" column="price"/>
        <result property="quantity" column="quantity"/>
    </resultMap>

    <!-- 订单 resultMap（包含订单项） -->
    <resultMap id="orderMap" type="com.hanxw.project.order.entity.OrderEntity">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="orderNo" column="order_no"/>
        <result property="amount" column="amount"/>
        <result property="createTime" column="create_time"/>
        <collection property="items"
                    ofType="com.hanxw.project.order.entity.OrderItemEntity"
                    column="id"
                    select="selectOrderItemsByOrderId"/>
    </resultMap>

    <!-- 查询用户订单（原有复杂查询简化版） -->
    <select id="selectUserWithOrders" resultMap="orderMap">
        SELECT o.id, o.user_id, o.order_no, o.amount, o.create_time
        FROM orders o
        WHERE o.user_id = #{userId}
        ORDER BY o.create_time DESC
    </select>

    <!-- 根据用户ID查询订单列表 -->
    <select id="selectByUserId" resultMap="orderMap">
        SELECT o.id, o.user_id, o.order_no, o.amount, o.create_time
        FROM orders o
        WHERE o.user_id = #{userId}
        ORDER BY o.create_time DESC
    </select>

    <!-- 子查询：根据订单ID查询订单项 -->
    <select id="selectOrderItemsByOrderId" resultMap="orderItemMap">
        SELECT id AS item_id, order_id, product_name, price, quantity
        FROM order_item
        WHERE order_id = #{id}
    </select>

</mapper>
