<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hanxw.project.mapper.OrderMapper">

    <resultMap id="orderItemForUserMap" type="com.hanxw.project.entity.OrderItemEntity">
        <id property="id" column="item_id"/>
        <result property="orderId" column="item_order_id"/>
        <result property="productName" column="item_product_name"/>
        <result property="price" column="item_price"/>
        <result property="quantity" column="item_quantity"/>
    </resultMap>

    <resultMap id="orderMapForUser" type="com.hanxw.project.entity.OrderEntity">
        <id property="id" column="order_id"/>
        <result property="userId" column="order_user_id"/>
        <result property="orderNo" column="order_no"/>
        <result property="amount" column="order_amount"/>
        <result property="createTime" column="order_create_time"/>

        <collection property="items"
                    ofType="com.hanxw.project.entity.OrderItemEntity"
                    resultMap="orderItemForUserMap"/>
    </resultMap>

    <resultMap id="userWithOrdersMap" type="com.hanxw.project.entity.UserEntity">
        <id property="id" column="user_id"/>
        <result property="username" column="username"/>
        <result property="password" column="password"/>
        <result property="createTime" column="user_create_time"/>

        <collection property="orders"
                    ofType="com.hanxw.project.entity.OrderEntity"
                    resultMap="orderMapForUser"/>
    </resultMap>

    <!-- 查询用户及其订单（关联查询 + resultMap） -->
    <select id="selectUserWithOrders" resultMap="userWithOrdersMap">
		SELECT
			u.id          AS user_id,
			u.username,
			u.password,
			u.create_time AS user_create_time,

			o.id          AS order_id,
			o.user_id     AS order_user_id,
			o.order_no,
			o.amount     AS order_amount,
			o.create_time AS order_create_time,

			i.id        AS item_id,
			i.order_id  AS item_order_id,
			i.product_name  AS item_product_name,
			i.price  AS item_price,
			i.quantity  AS item_quantity
		FROM user u
		LEFT JOIN orders o ON u.id = o.user_id
		LEFT JOIN order_item i ON o.id = i.order_id
		WHERE u.id = #{userId}
    </select>

    <!-- 通用 resultMap：订单项 -->
    <resultMap id="orderItemMap" type="com.hanxw.project.entity.OrderItemEntity">
        <id property="id" column="item_id"/>
        <result property="orderId" column="order_id"/>
        <result property="productName" column="product_name"/>
        <result property="price" column="price"/>
        <result property="quantity" column="quantity"/>
    </resultMap>

    <!-- 通用 resultMap：订单（包含订单项集合） -->
    <resultMap id="orderMap" type="com.hanxw.project.entity.OrderEntity">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="orderNo" column="order_no"/>
        <result property="amount" column="amount"/>
        <result property="createTime" column="create_time"/>

        <collection property="items"
                    ofType="com.hanxw.project.entity.OrderItemEntity"
                    column="id"
                    select="selectOrderItemsByOrderId"/>
    </resultMap>

    <!-- 子查询：根据订单ID查询订单项（用于 collection） -->
    <select id="selectOrderItemsByOrderId" resultMap="orderItemMap">
        SELECT id AS item_id, order_id, product_name, price, quantity
        FROM order_item
        WHERE order_id = #{id}
    </select>

    <!-- 动态 SQL 查询订单（演示 <if>、<where>、<foreach>） + 手动分页 -->
    <select id="selectOrdersDynamic" resultMap="orderMap">
        SELECT o.id, o.user_id, o.order_no, o.amount, o.create_time
        FROM orders o
        <where>
            <if test="userId != null">
                o.user_id = #{userId}
            </if>
            <if test="minAmount != null">
                AND o.amount >= #{minAmount}
            </if>
            <if test="productNames != null and productNames.size() > 0">
                AND EXISTS (
                SELECT 1 FROM order_item oi
                WHERE oi.order_id = o.id
                AND oi.product_name IN
                <foreach collection="productNames" item="name" open="(" separator="," close=")">
                    #{name}
                </foreach>
                )
            </if>
        </where>
        ORDER BY o.create_time DESC
        LIMIT #{offset}, #{limit}  <!-- 手动分页实现 -->
    </select>

    <!-- 查询订单及其订单项（collection 嵌套查询） -->
    <select id="selectOrdersWithItems" resultMap="orderMap">
        SELECT o.id, o.user_id, o.order_no, o.amount, o.create_time
        FROM orders o
        <if test="orderIds != null and orderIds.size() > 0">
            WHERE o.id IN
            <foreach collection="orderIds" item="id" open="(" separator="," close=")">
                #{id}
            </foreach>
        </if>
    </select>

</mapper>